<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Time-Turner — Empneo Experience</title>

<!-- Google font -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

<style>
  /* -----------------------
     GLOBAL & LAYOUT
     ----------------------- */
  :root{
    --bg:#0b0710;
    --parchment:#f6ecd8;
    --accent:#e9c46a;
    --muted:#a08b6b;
    --glass: rgba(255,255,255,0.06);
    --glass-2: rgba(255,255,255,0.03);
    --card-shadow: 0 10px 30px rgba(4,4,6,0.6);
    --gold-glow: 0 0 18px rgba(238,190,87,0.75), 0 0 40px rgba(238,190,87,0.12);
    --max-width:1100px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 600px at 10% 10%, rgba(255,240,210,0.02), transparent 10%),
      linear-gradient(160deg,#04030b 0%, #0b0710 50%, #0f0d14 100%);
    color: #f7efe2;
    font-family: 'Roboto', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding: 28px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .shell{
    width:100%;
    max-width:var(--max-width);
    margin: 0 auto;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap: 28px;
    align-items:start;
  }

  /* -----------------------
     LEFT PANEL - TIME-TURNER
     ----------------------- */
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:18px;
    padding:20px;
    box-shadow: var(--card-shadow);
    position:relative;
    overflow:hidden;
    min-height:520px;
  }

  .logo {
    display:flex;
    align-items:center;
    gap:12px;
  }
  .logo .title{
    font-family: 'Cinzel', serif;
    font-weight:700;
    color:var(--parchment);
    font-size:20px;
    letter-spacing:1px;
  }
  .logo .sub{
    font-size:12px;
    color:var(--muted);
  }

  /* parchment strip */
  .parchment-strip{
    margin-top:14px;
    background:
      linear-gradient(180deg, rgba(255,245,220,0.06), rgba(255,245,200,0.02));
    border-radius:10px;
    padding:10px;
    text-align:center;
    color:var(--parchment);
    font-weight:500;
    font-size:14px;
    box-shadow: inset 0 -6px 18px rgba(0,0,0,0.35);
  }

  /* big time-turner area */
  .turner-wrap{
    margin-top:18px;
    height:340px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }

  /* sky of sparkles */
  .sparkles{
    position:absolute;
    inset:0;
    pointer-events:none;
  }
  /* particle small dot */
  .spark{
    position:absolute;
    width:6px;height:6px;
    background: radial-gradient(circle at 30% 30%, #fff 0%, #ffd98b 40%, transparent 60%);
    box-shadow:0 0 12px rgba(255,210,120,0.95);
    border-radius:50%;
    opacity:0;
    transform:translate3d(0,0,0) scale(0.5);
    will-change:transform,opacity;
  }

  /* time-turner element */
  .turner{
    width:260px;
    height:260px;
    border-radius:50%;
    background: conic-gradient(from 0deg, rgba(248,217,126,0.12), rgba(248,217,126,0.06));
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    box-shadow: var(--gold-glow), 0 8px 24px rgba(0,0,0,0.6);
    transition: transform 0.8s cubic-bezier(.2,.9,.2,1), filter .3s;
    cursor:grab;
    user-select:none;
    touch-action:none;
  }

  .turner:active{cursor:grabbing}
  .turner .rings{
    width:220px;height:220px;border-radius:50%;position:relative;display:block;
    transform-style:preserve-3d;
  }

  /* SVG ring styling container */
  .ring {
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
  }

  /* inner dial */
  .dial{
    width:86px;height:86px;border-radius:50%;
    background:linear-gradient(180deg,#f2e1b3,#e6c875);
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 6px 12px rgba(0,0,0,0.45), inset 0 4px 8px rgba(255,255,255,0.2);
    border:2px solid rgba(255,240,200,0.15);
    transform:translateZ(20px);
  }
  .dial .gem{
    width:38px;height:38px;border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #fff 0%, #b7e5ff 30%, #73b8f7 70%);
    box-shadow: 0 8px 18px rgba(115,184,247,0.28), inset 0 2px 6px rgba(255,255,255,0.6);
  }

  /* control buttons */
  .controls{
    margin-top:18px;
    display:flex;
    gap:10px;
    justify-content:center;
    align-items:center;
  }
  .btn{
    background:linear-gradient(180deg,var(--accent), #d49731);
    padding:10px 16px;
    border-radius:12px;
    font-weight:700;
    color:#070606;
    border:none;
    cursor:pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.5);
  }
  .btn.secondary{
    background:transparent;color:var(--parchment);
    border:1px solid rgba(255,255,255,0.06);
    box-shadow:none;
    font-weight:600;
  }

  .small-text{
    font-size:12px;color:var(--muted);
    margin-top:8px;text-align:center;
  }

  /* -----------------------
     RIGHT PANEL - RESULTS
     ----------------------- */
  .panel-right{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:18px;
    padding:20px;
    box-shadow: var(--card-shadow);
    min-height:520px;
    display:flex;
    flex-direction:column;
    gap:14px;
    position:relative;
    overflow:hidden;
  }

  .headline{
    font-family:'Cinzel',serif;
    font-size:28px;
    color:var(--accent);
    letter-spacing:1px;
    display:flex;
    gap:12px;
    align-items:center;
  }
  .headline .dot{
    width:10px;height:10px;border-radius:50%;background:var(--accent);
    box-shadow:0 0 10px rgba(238,190,87,0.6);
  }

  /* Daily-Prophet card */
  .news-card{
    margin-top:6px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:16px;
    display:flex;
    gap:16px;
    align-items:flex-start;
    transform: translateY(0);
    transition: transform .5s cubic-bezier(.2,.9,.2,1), opacity .45s;
  }

  .news-left{
    flex:0 0 120px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  .crest{
    width:86px;height:86px;border-radius:12px;
    background: linear-gradient(180deg,#222 0%, #151515 100%);
    display:flex;align-items:center;justify-content:center;
    border:2px solid rgba(255,255,255,0.04);
    box-shadow:0 8px 18px rgba(0,0,0,0.6);
    overflow:hidden;
  }
  .crest img{width:100%;height:100%;object-fit:cover;display:block}

  .news-body{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .meta{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .meta .badge{
    background: rgba(255,255,255,0.03);
    color:var(--parchment);
    padding:6px 10px;border-radius:8px;font-size:13px;
  }

  .event-title{
    font-family:'Cinzel',serif;
    font-size:18px;
    color: #fff;
    margin:0;
  }

  .event-desc{
    color:var(--muted);
    font-size:14px;
    margin:0;
  }

  .motiv{
    margin-top:8px;
    background: linear-gradient(90deg, rgba(233,196,106,0.06), rgba(233,196,106,0.02));
    padding:10px;border-radius:10px;border:1px solid rgba(233,196,106,0.06);
    color:var(--parchment);
    font-weight:600;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  .mot-key{font-size:13px;color:var(--muted)}
  .mot-val{font-family:'Cinzel',serif;color:var(--accent)}

  /* footer small */
  .attribution{
    margin-top:auto;
    font-size:12px;color:var(--muted);
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;
  }

  /* glow headline animation */
  @keyframes popIn {
    0%{transform:translateY(12px);opacity:0}
    100%{transform:translateY(0);opacity:1}
  }

  /* responsive */
  @media (max-width:980px){
    .shell{grid-template-columns:1fr; padding:0 8px}
    .turner{width:220px;height:220px}
    .panel, .panel-right{min-height:420px}
  }

  @media (max-width:520px){
    .turner{width:180px;height:180px}
    .turner .rings{width:160px;height:160px}
    .news-left{display:none}
    .headline{font-size:20px}
  }
</style>
</head>
<body>
  <div class="shell" role="main" aria-labelledby="title">
    <!-- LEFT: INTERACTION -->
    <section class="panel" aria-label="Time Turner control panel">
      <div class="logo" id="title">
        <svg width="36" height="36" viewBox="0 0 24 24" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#ffefb1"/>
              <stop offset="1" stop-color="#f2c46b"/>
            </linearGradient>
          </defs>
          <circle cx="12" cy="12" r="10" fill="url(#g1)"/>
          <path d="M6 12c1.5-3 4.5-4.5 6-4.5S17 9 18 12" stroke="#8a5a1f" stroke-width="1.2" fill="none"/>
        </svg>
        <div>
          <div class="title">Time-Turner — Empneo</div>
          <div class="sub">Exclusive timeline glimpses • Interactive demo</div>
        </div>
      </div>

      <div class="parchment-strip" id="hint">Tap/drag the Time-Turner • Full spin = new era</div>

      <div class="turner-wrap" aria-hidden="false">
        <div class="sparkles" id="sparkles" aria-hidden="true"></div>

        <div class="turner" id="turner" role="slider" tabindex="0"
             aria-label="Time Turner dial. Drag or press space to spin." aria-valuenow="0" aria-valuemin="-10000" aria-valuemax="10000">
          <div class="rings" id="rings" aria-hidden="true">
            <!-- Animated rings rendered with inline SVG for crispness -->
            <div class="ring" style="transform:rotateZ(0deg)">
              <svg viewBox="0 0 260 260" width="100%" height="100%" aria-hidden="true">
                <defs>
                  <linearGradient id="gold1" x1="0" x2="1">
                    <stop offset="0" stop-color="#f4e2a5"/>
                    <stop offset="1" stop-color="#e1a84a"/>
                  </linearGradient>
                  <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur stdDeviation="6" result="b"/>
                    <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                  </filter>
                </defs>
                <g transform="translate(130,130)">
                  <circle r="106" fill="none" stroke="url(#gold1)" stroke-width="8" filter="url(#glow)" opacity="0.95"/>
                  <g transform="rotate(30)">
                    <path d="M-80 0 a80 80 0 1 1 160 0" stroke="#d59b36" stroke-width="2" fill="none" opacity="0.15"/>
                  </g>
                </g>
              </svg>
            </div>

            <div class="ring" style="transform:rotateZ(20deg)">
              <svg viewBox="0 0 220 220" width="80%" height="80%" aria-hidden="true">
                <g transform="translate(110,110)">
                  <circle r="78" fill="none" stroke="#fef0cc" stroke-width="4" opacity="0.18"/>
                  <path d="M-60 -10 q30 30 60 10" stroke="#f0d59e" stroke-width="3" fill="none" opacity="0.12"/>
                </g>
              </svg>
            </div>

            <div class="ring" style="transform:rotateZ(-20deg)">
              <div class="dial" aria-hidden="true">
                <div class="gem"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="spinButton" aria-pressed="false">Spin ✨</button>
        <button class="btn secondary" id="resetBtn">Go Back to Present</button>
      </div>

      <div class="small-text">Tip: On mobile, flick the dial with your finger. The faster the flick, the farther back or forward you travel.</div>

      <!-- audio elements (placeholders, use licensed audio) -->
      <audio id="tickAudio" preload="auto">
        <source src="https://cdn.jsdelivr.net/gh/himalayasingh/music-mp3@latest/soft-clock-tick.mp3" type="audio/mpeg">
        <!-- Replace URL above with your licensed tick sound -->
      </audio>

      <audio id="spinSfx" preload="auto">
        <!-- placeholder gentle whoosh -->
        <source src="https://cdn.jsdelivr.net/gh/anars/blank-audio@master/1-second-of-silence.mp3" type="audio/mpeg">
      </audio>

      <audio id="bgMusic" loop preload="auto">
        <!-- subtle background ambience, replace with a proper licensed track -->
        <source src="https://cdn.jsdelivr.net/gh/anars/blank-audio@master/1-second-of-silence.mp3" type="audio/mpeg">
      </audio>
    </section>

    <!-- RIGHT: RESULTS / NEWS -->
    <aside class="panel-right" aria-label="Event results and details">
      <div class="headline" aria-hidden="false">
        <div class="dot" aria-hidden="true"></div>
        <div id="mainHeadline">Only for the Chosen: Unlock Hidden Moments</div>
      </div>

      <div class="news-card" id="newsCard" role="article" aria-live="polite" style="opacity:1; transform:none;">
        <div class="news-left" aria-hidden="false">
          <div class="crest" id="crest">
            <!-- placeholder crest; replace with house crest images -->
            <img id="crestImg" src="https://i.imgur.com/3Xk6Z5v.png" alt="House crest placeholder">
          </div>
          <div class="meta">
            <div class="badge" id="eraBadge">Year</div>
          </div>
        </div>

        <div class="news-body">
          <h2 class="event-title" id="eventTitle">Spin the Time-Turner to reveal a moment</h2>
          <p class="event-desc" id="eventDesc">Each spin reveals a magical event, a short exclusive summary, and a motivational aspect. Try it now — press Spin or drag the dial.</p>

          <div class="motiv" id="motivBox" aria-hidden="false">
            <div class="mot-key" id="motKey">Motivational Aspect</div>
            <div class="mot-val" id="motVal">Courage</div>
          </div>
        </div>
      </div>

      <div class="attribution">
        <div>Interactive demo • Built for Empneo</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn secondary" id="musicBtn" aria-pressed="false">Toggle Ambience</button>
          <button class="btn secondary" id="shareBtn">Share</button>
        </div>
      </div>
    </aside>
  </div>

<script>
/* ============================
   JavaScript: Interaction + UI
   ============================ */

/*
  Overview:
  - drag/spin the .turner to set angular velocity
  - flick gesture applies velocity; spin animation controlled by JS
  - when spin stops (velocity below threshold) we snap to a result
  - on each "full rotation" or final resting angle we determine an event
  - particles, sounds and results update accordingly
*/

/* ---------- Helpers ---------- */
const rand = (min,max) => Math.random()*(max-min)+min;
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const choose = arr => arr[Math.floor(Math.random()*arr.length)];

/* ---------- Data (events) ---------- */
/* Keep these generic to avoid copyrighted lines. Replace or expand with your own lore. */
const EVENTS = [
  { year: 1879, title:"Founding of the Hidden Library", desc:"A secret magical library is established beneath an ancient oak. Rare spell scrolls are housed here.", motiv:"Curiosity & Knowledge", crest:"https://i.imgur.com/3Xk6Z5v.png" },
  { year: 1923, title:"Midnight Duel at Raven's Hollow", desc:"Two rival prodigies duel under moonlight, changing local wizarding customs forever.", motiv:"Courage in Adversity", crest:"https://i.imgur.com/3Xk6Z5v.png" },
  { year: 1991, title:"A New Student Arrives at the Castle", desc:"A brave young wizard crosses the threshold — beginnings are sacred.", motiv:"Self-Belief", crest:"https://i.imgur.com/3Xk6Z5v.png" },
  { year: 1999, title:"The Great Feast that United Houses", desc:"An unprecedented celebration fosters strong alliances and friendships.", motiv:"Unity & Teamwork", crest:"https://i.imgur.com/3Xk6Z5v.png" },
  { year: 2007, title:"The Wandwright's Invention", desc:"A clever wandwright creates modular wands, changing the craft forever.", motiv:"Innovation & Creativity", crest:"https://i.imgur.com/3Xk6Z5v.png" },
  { year: 2030, title:"Ministry Reforms Unveiled", desc:"A visionary leader introduces reforms that benefit the many.", motiv:"Leadership & Service", crest:"https://i.imgur.com/3Xk6Z5v.png" },
  { year: 2045, title:"The Observatory's First Light", desc:"Wizards witness an aurora of rare magical energies, inspiring a generation.", motiv:"Wonder & Ambition", crest:"https://i.imgur.com/3Xk6Z5v.png" },
  { year: -500, title:"The Ancient Pact", desc:"Founding families sign a pact protecting secret knowledge for millennia.", motiv:"Stewardship & Legacy", crest:"https://i.imgur.com/3Xk6Z5v.png" }
];

/* ---------- DOM nodes ---------- */
const turner = document.getElementById('turner');
const rings = document.getElementById('rings');
const spinBtn = document.getElementById('spinButton');
const resetBtn = document.getElementById('resetBtn');
const eventTitle = document.getElementById('eventTitle');
const eventDesc = document.getElementById('eventDesc');
const eraBadge = document.getElementById('eraBadge');
const motVal = document.getElementById('motVal');
const motKey = document.getElementById('motKey');
const crestImg = document.getElementById('crestImg');
const newsCard = document.getElementById('newsCard');
const mainHeadline = document.getElementById('mainHeadline');
const hint = document.getElementById('hint');

const tickAudio = document.getElementById('tickAudio');
const spinSfx = document.getElementById('spinSfx');
const bgMusic = document.getElementById('bgMusic');

const musicBtn = document.getElementById('musicBtn');
const shareBtn = document.getElementById('shareBtn');

const sparkles = document.getElementById('sparkles');

/* ---------- Spin state ---------- */
let angle = 0;           // current angle in degrees
let velocity = 0;        // degrees per second
let lastTime = null;
let animFrame = null;
let dragging = false;
let dragStart = null;
let dragLast = null;
let allowSound = false;

/* ---------- Particle System ---------- */
const MAX_SPARKS = 28;
let sparks = [];
function createSpark(x,y){
  const el = document.createElement('div');
  el.className = 'spark';
  sparkles.appendChild(el);
  const life = rand(900,1800); // ms
  const vx = rand(-0.6,0.6);
  const vy = rand(-0.8,-0.2);
  const scale = rand(0.6,1.1);
  el.style.left = `${x}px`;
  el.style.top = `${y}px`;
  el.style.opacity = '0.0';
  el.style.transform = `translate3d(0,0,0) scale(${scale})`;
  const start = performance.now();
  sparks.push({el, start, life, vx, vy, ox:x, oy:y});
  // cleanup later
}

function updateSparks(now){
  for(let i=sparks.length-1;i>=0;i--){
    const s = sparks[i];
    const t = (now - s.start);
    if(t> s.life+200){
      s.el.remove(); sparks.splice(i,1); continue;
    }
    const p = Math.min(1, t / s.life);
    const x = s.ox + s.vx * p * 200;
    const y = s.oy + s.vy * p * 200;
    s.el.style.left = `${x}px`;
    s.el.style.top = `${y}px`;
    s.el.style.opacity = `${Math.sin(p * Math.PI) * 0.95}`;
    const scale = 0.6 + p*0.6;
    s.el.style.transform = `translate3d(0,0,0) scale(${scale})`;
  }
}

/* ---------- Visual Helpers ---------- */
function pulseHeadline(text){
  mainHeadline.style.opacity = 0;
  mainHeadline.style.transform = 'translateY(8px)';
  setTimeout(()=>{ mainHeadline.textContent = text; mainHeadline.style.transition='all .45s cubic-bezier(.2,.9,.2,1)'; mainHeadline.style.opacity=1; mainHeadline.style.transform='translateY(0)'; },60);
}

/* ---------- Result rendering ---------- */
function showResult(event){
  // small animation for card
  newsCard.style.opacity = 0;
  newsCard.style.transform = 'translateY(16px)';
  setTimeout(()=>{
    eraBadge.textContent = event.year;
    eventTitle.textContent = event.title;
    eventDesc.textContent = event.desc;
    motVal.textContent = event.motiv;
    crestImg.src = event.crest || 'https://i.imgur.com/3Xk6Z5v.png';
    // subtle headline change
    pulseHeadline(`Only for You: ${event.title}`);
    newsCard.style.opacity = 1;
    newsCard.style.transform = 'translateY(0)';
  },200);
}

/* ---------- Choose an event based on angle ---------- */
function pickEventFromAngle(a){
  // Normalize angle into 0..360
  let normalized = ((a % 360) + 360) % 360;
  // Map to index by slices
  const slice = Math.floor((normalized / 360) * EVENTS.length);
  // Slight randomness for variety
  const idx = (slice + Math.floor(rand(0,EVENTS.length))) % EVENTS.length;
  return EVENTS[idx];
}

/* ---------- Spin behaviour ---------- */
function animate(now){
  if(!lastTime) lastTime = now;
  const dt = (now - lastTime) / 1000; // seconds
  lastTime = now;

  // integrate: angle += velocity * dt
  if(!dragging){
    // apply friction
    const friction = 20; // higher = quicker stop
    const sign = Math.sign(velocity);
    velocity -= sign * friction * dt;
    if(Math.sign(velocity) !== sign) velocity = 0;
  }

  angle += velocity * dt;
  // apply slow wobble
  rings.style.transform = `rotate(${angle}deg) translateZ(0)`;

  // emit sparks occasionally if spinning
  if(Math.abs(velocity) > 60 && Math.random() < 0.08){
    // position sparks near center of turner
    const rect = turner.getBoundingClientRect();
    const x = rand( rect.width*0.3, rect.width*0.7 );
    const y = rand( rect.height*0.3, rect.height*0.7 );
    createSpark(x,y);
    // play tick sound lightly
    if(allowSound && tickAudio){
      tickAudio.currentTime = 0; tickAudio.volume = 0.18; tickAudio.play().catch(()=>{/* silent */});
    }
  }

  updateSparks(now);

  // if moving slow enough and not dragging -> stop and show result
  if(!dragging && Math.abs(velocity) < 6){
    // snap velocity to zero and choose event if not already displayed
    if(velocity !== 0){
      velocity = 0;
      // choose event
      const ev = pickEventFromAngle(angle);
      showResult(ev);
      // subtle spin SFX
      if(allowSound && spinSfx){
        spinSfx.currentTime = 0; spinSfx.play().catch(()=>{});
      }
    }
  }

  animFrame = requestAnimationFrame(animate);
}

/* ---------- Drag / Touch handlers ---------- */
function onPointerDown(e){
  dragging = true;
  dragStart = {x: e.clientX, y: e.clientY, time: performance.now(), angleAtStart: angle};
  dragLast = {...dragStart};
  // stop any ongoing fling
  velocity = 0;
  lastTime = null; // so dt is fresh
  // clear sparkles
  while(sparkles.firstChild) sparkles.firstChild.remove();
}

function onPointerMove(e){
  if(!dragging) return;
  const rect = turner.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  // compute angle between center and pointer
  const a1 = Math.atan2(dragLast.y - cy, dragLast.x - cx);
  const a2 = Math.atan2(e.clientY - cy, e.clientX - cx);
  const da = (a2 - a1) * 180 / Math.PI;
  angle += da;
  rings.style.transform = `rotate(${angle}deg)`;
  // small immediate spark
  if(Math.random() < 0.3) createSpark(e.clientX - rect.left, e.clientY - rect.top);
  dragLast = {x:e.clientX, y:e.clientY, time: performance.now()};
}

function onPointerUp(e){
  if(!dragging) return;
  dragging = false;
  const now = performance.now();
  const dt = (now - dragLast.time) / 1000 || 0.016;
  // estimate velocity from last movement (degrees per second)
  // compute angle delta between dragStart and last pointer against center
  const rect = turner.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  const aLast = Math.atan2(dragLast.y - cy, dragLast.x - cx);
  const aNow = Math.atan2((e.clientY || dragLast.y) - cy, (e.clientX || dragLast.x) - cx);
  let da = (aNow - aLast) * 180 / Math.PI;
  // fallback: use movement vector
  const mvx = (e.clientX || dragLast.x) - dragStart.x;
  const mvy = (e.clientY || dragLast.y) - dragStart.y;
  const speed = Math.hypot(mvx,mvy);
  // Calculate approximate angular velocity proportional to flick speed and direction
  let estimated = (da / dt) * 1.25 + (speed * 0.6);
  if(Math.abs(estimated) < 40){
    // if small, set a modest rotation depending on drag direction
    estimated = (mvx + (mvx>0?100:-100)) * 0.6;
  }
  // clamp
  velocity = clamp(estimated, -3000, 3000);

  // allow vibration feedback for mobile
  if(navigator.vibrate) navigator.vibrate(60);
}

/* ---------- Mouse & Touch glue ---------- */
let pointerId = null;

turner.addEventListener('pointerdown', (ev)=>{ ev.preventDefault(); turner.setPointerCapture(ev.pointerId); pointerId = ev.pointerId; onPointerDown(ev); });
turner.addEventListener('pointermove', (ev)=>{ if(pointerId===ev.pointerId) onPointerMove(ev); });
turner.addEventListener('pointerup', (ev)=>{ if(pointerId===ev.pointerId){ pointerId=null; turner.releasePointerCapture(ev.pointerId); onPointerUp(ev); }});
turner.addEventListener('pointercancel', (ev)=>{ if(pointerId===ev.pointerId){ pointerId=null; turner.releasePointerCapture(ev.pointerId); onPointerUp(ev); }});


// keyboard accessibility: space to spin a preset amount
turner.addEventListener('keydown', (e)=>{
  if(e.key === ' ' || e.key === 'Enter'){
    e.preventDefault();
    // apply a small velocity
    velocity += 800;
  } else if(e.key === 'ArrowLeft'){
    velocity -= 320; e.preventDefault();
  } else if(e.key === 'ArrowRight'){
    velocity += 320; e.preventDefault();
  }
});

/* ---------- Buttons ---------- */
spinBtn.addEventListener('click', (ev)=>{
  // allow sounds only after first user gesture
  allowSound = true;
  // give a random strong spin
  velocity += rand(1200, 2600) * (Math.random() > 0.4 ? 1 : -1);
  if(navigator.vibrate) navigator.vibrate(30);
});

resetBtn.addEventListener('click', ()=>{
  // reset to neutral angle and show "present" card
  velocity = 0;
  angle = 0;
  rings.style.transform = `rotate(${angle}deg)`;
  showResult({year: new Date().getFullYear(), title:'Back to the Present', desc:'You are in the present. Many opportunities await — create one now.', motiv:'Present Focus', crest:'https://i.imgur.com/3Xk6Z5v.png'});
  pulseHeadline('Returned: Present Moment');
});

/* ---------- Music control ---------- */
musicBtn.addEventListener('click', ()=>{
  if(bgMusic.paused){
    bgMusic.volume = 0.16;
    bgMusic.play().catch(()=>{/* autoplay blocked until user interacts */});
    musicBtn.textContent = 'Ambience On';
    musicBtn.setAttribute('aria-pressed','true');
    allowSound = true;
  } else {
    bgMusic.pause();
    musicBtn.textContent = 'Toggle Ambience';
    musicBtn.setAttribute('aria-pressed','false');
  }
});

/* ---------- Share button (simple) ---------- */
shareBtn.addEventListener('click', async ()=>{
  const sharePayload = {
    title: 'Time-Turner • Empneo',
    text: 'Check out this magical time-turner demo I found at Empneo!',
    url: window.location.href
  };
  if(navigator.share){
    try{ await navigator.share(sharePayload); }catch(e){ alert('Share cancelled'); }
  } else {
    // fallback: copy to clipboard
    try{
      await navigator.clipboard.writeText(window.location.href);
      alert('Link copied to clipboard! Share it with your friends.');
    }catch(e){
      prompt('Copy this URL', window.location.href);
    }
  }
});

/* ---------- Spark pre-populate (gentle) ---------- */
function initSparks(){
  // create a few ambient sparks in random positions (visual only)
  const rect = turner.getBoundingClientRect();
  for(let i=0;i<6;i++){
    const x = rand(rect.width*0.1, rect.width*0.9);
    const y = rand(rect.height*0.1, rect.height*0.9);
    createSpark(x,y);
  }
}

/* ---------- Start animation loop ---------- */
animFrame = requestAnimationFrame(animate);
lastTime = performance.now();

/* ---------- Initialize with a welcome event ---------- */
showResult({year: '—', title: 'Welcome, Chosen One', desc:'Spin, flick or press the Time-Turner to glimpse magical moments. Each reveal contains a motivational take-away.', motiv:'Begin the Journey', crest:'https://i.imgur.com/3Xk6Z5v.png'});

/* ---------- Resize handling: keep spark area consistent ---------- */
window.addEventListener('resize', ()=>{
  // clear old sparks to avoid position drift
  while(sparkles.firstChild) sparkles.firstChild.remove();
});

/* ---------- Small UX polish: hint fadeout ---------- */
setTimeout(()=>{ hint.style.opacity = 0.7; }, 900);
setTimeout(()=>{ hint.style.opacity = 0.5; }, 2400);

/* ---------- Expose for debugging (optional) ---------- */
window._timeTurner = { getAngle: ()=>angle, getVelocity: ()=>velocity, EVENTS };

/* ---------- Accessibility: focus outline ---------- */
turner.addEventListener('focus', ()=>{ turner.style.boxShadow = '0 0 0 4px rgba(233,196,106,0.12)';});
turner.addEventListener('blur', ()=>{ turner.style.boxShadow = 'var(--gold-glow)'; });

</script>
</body>
</html>


